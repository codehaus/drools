
<project default="drools:build" xmlns:jxr="jxr" xmlns:j="jelly:core">

    <preGoal name="site:generate">
        <attainGoal name="clover"/>
    </preGoal>

    <preGoal name="test:test">
        <!-- ${maven.test.dest} is not available here ??? -->
        <copy toDir="${maven.build.dir}/test-classes">
            <fileset dir="${basedir}/src/java/main/">
                <include name="**/*.xml"/>
            </fileset>
        </copy>
    </preGoal>

    <postGoal name="clover">
        <copy tofile="${basedir}/target/docs/clover/style.css"
            file="${basedir}/xdocs/stylesheets/clover-style.css"
            overwrite="true"/>
        <copy tofile="${basedir}/target/docs/clover/pkgs-summary"
            file="${basedir}/target/docs/clover/pkgs-summary.html"/>
    </postGoal>

    <goal name="ant:generate-build">
        <echo>ant build not supported</echo>
    </goal>

    <goal name="drools:build">
        <attainGoal name="jar:jar"/>
        <attainGoal name="drools:rar"/>
        <attainGoal name="drools:war"/>
    </goal>

    <goal name="drools:compile-examples">
        <echo>compiling examples</echo>
        <mkdir dir="${drools.examples.dest.dir}"/>
        <javac srcdir="${drools.examples.src.dir}"
            destdir="${drools.examples.dest.dir}">
            <classpath>
                <path refid="maven.dependency.classpath"/>
                <path location="target/${maven.final.name}.jar"/>
            </classpath>
        </javac>
        <copy toDir="${drools.examples.dest.dir}">
            <fileset dir="${drools.examples.src.dir}">
                <include name="**/*.drl"/>
            </fileset>
        </copy>
    </goal>

    <goal name="drools:deploy-jboss" prereqs="drools:rar, drools:war">
        <copy file="${basedir}/etc/drools-jsr94-ds.xml" todir="${maven.build.dir}"/>
        <copy file="${maven.build.dir}/${maven.final.name}.rar" todir="${maven.jboss.home}/server/default/deploy"/>
        <copy file="${maven.build.dir}/drools-jsr94-ds.xml" todir="${maven.jboss.home}/server/default/deploy"/>
        <copy file="${maven.build.dir}/${maven.final.name}.war" todir="${maven.jboss.home}/server/default/deploy"/>
    </goal>

    <goal name="drools:get-deps">
        <mkdir dir="${maven.build.dir}/lib"/>

        <!-- copy maven repository jars to target lib -->
        <copy todir="${maven.build.dir}/lib" flatten="true">
            <fileset dir="${maven.repo.local}">
                <j:forEach var="dep" items="${pom.dependencies}">
                    <include name="${dep.artifactDirectory}/jars/${dep.artifact}"/>
                </j:forEach>
            </fileset>
        </copy>
    </goal>

    <goal name="drools:examples">
        <attainGoal name="drools:example-escalation"/>
        <attainGoal name="drools:example-fishmonger"/>
        <attainGoal name="drools:example-sisters"/>
    </goal>

    <goal name="drools:example-escalation"
        prereqs="drools:compile-examples">
        <echo>running escalation example</echo>
        <java classname="escalation.Escalation" fork="true">
            <classpath>
                <path refid="maven.dependency.classpath"/>
                <path location="target/${maven.final.name}.jar"/>
                <path location="${drools.examples.dest.dir}"/>
            </classpath>
        </java>
    </goal>

    <goal name="drools:example-sisters"
        prereqs="drools:compile-examples">
        <echo>running sisters example</echo>
        <java classname="sisters.Sisters" fork="true">
            <classpath>
                <path refid="maven.dependency.classpath"/>
                <path location="target/${maven.final.name}.jar"/>
                <path location="${drools.examples.dest.dir}"/>
            </classpath>
        </java>
    </goal>

    <goal name="drools:example-fishmonger"
        prereqs="drools:compile-examples">
        <echo>running fishmonger example</echo>
        <java classname="fishmonger.FishMonger" fork="true">
            <classpath>
                <path refid="maven.dependency.classpath"/>
                <path location="target/${maven.final.name}.jar"/>
                <path location="${drools.examples.dest.dir}"/>
            </classpath>
        </java>
    </goal>

    <goal name="drools:rar" prereqs="drools:get-deps">
        <jar jarfile="${maven.build.dir}/${maven.final.name}.rar">
            <fileset dir="${maven.build.dir}">
                <include name="${maven.final.name}.jar"/>
            </fileset>
            <fileset dir="${maven.build.dir}/lib">
                <include name="antlr-*.jar"/>
                <include name="commons-*.jar"/>
                <include name="dom4j-*.jar"/>
                <include name="xerces-*.jar"/>
                <include name="xml-apis-*.jar"/>
            </fileset>
            <fileset dir="${basedir}/common-lib">
                <include name="jsr94-*.jar"/>
            </fileset>
            <metainf dir="${basedir}/etc" includes="ra.xml"/>
        </jar>

    </goal>

    <goal name="drools:war">
        <war destfile="${maven.build.dir}/${maven.final.name}.war"
            webxml="${maven.src.dir}/webapp/web-inf/web.xml">
            <fileset dir="${maven.src.dir}/webapp">
                <include name="**/*.*"/>
                <exclude name="**/web.xml"/>
            </fileset>
            <fileset dir="${maven.src.dir}/java/test/org/drools/jsr94">
                <include name="sisters.drl"/>
            </fileset>
            <classes dir="${maven.build.dir}/test-classes">
                <include name="**/Person.class"/>
            </classes>
            <lib dir="${basedir}/common-lib">
                <include name="jsr94-*.jar"/>
            </lib>
        </war>
    </goal>

</project>
