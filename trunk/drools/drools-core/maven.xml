<?xml version="1.0" encoding="UTF-8"?>
<project
    default="default"
    xmlns:ant="jelly:ant"
    xmlns:j="jelly:core"
    xmlns:util="jelly:util"
    xmlns:maven="jelly:maven">

    <goal name="default" >
        <attainGoal name="jar:install"/>
    </goal>

    <postGoal name="clover">
        <copy tofile="${basedir}/target/docs/clover/pkgs-summary"
            file="${basedir}/target/docs/clover/pkgs-summary.html"/>
    </postGoal>


    <preGoal name="build:start" >
        <j:set var="droolsAspects" value="${drools.aspects}"/>
        <j:if test="${droolsAspects != null}">
	        <j:set var="groupId" value="maven" />
	        <j:set var="artifactId" value="maven-aspectj-plugin" />
	        <j:set var="version" value="3.2" />
	        <attainGoal name="plugin:download-artifact" />
					<maven:installPlugin file="${maven.repo.local}/${groupId}/plugins/${artifactId}-${version}.jar" cache="false" />
        </j:if>
    </preGoal>

    <preGoal name="java:compile">
        <j:if test="${droolsAspects != null}">
            <util:tokenize var="tokens" delim="," trim="true">${droolsAspects}</util:tokenize>

            <j:forEach var="token" items="${tokens}">
              <j:set var="mavenAspects" value="${mavenAspects},src/aspects/conf/${token.trim()}.lst"/>
            </j:forEach>

            <j:if test="${mavenAspects != ''}">
            	 <attainGoal name="clean"/>
               <j:set var="maven.aspectj.argfiles" value="${mavenAspects}" />
               <attainGoal name="aspectj:compile"/>
            </j:if>
        </j:if>
    </preGoal>

    <goal name="reports:publish">
        <j:set var="drools.dcontrol.htdocs.module" value="${drools.dcontrol.htdocs}/drools-core"/>
        <ant:delete dir="${drools.dcontrol.htdocs.module}/clover"/>
        <ant:copy todir="${drools.dcontrol.htdocs.module}/clover">
            <ant:fileset dir="${basedir}/target/docs/clover"/>
        </ant:copy>

        <ant:delete dir="${drools.dcontrol.htdocs.module}/junit"/>
        <ant:copy todir="${drools.dcontrol.htdocs.module}/junit">
            <ant:fileset dir="${basedir}/target/test-reports"/>
        </ant:copy>

        <ant:delete dir="${drools.dcontrol.htdocs.module}/checkstyle"/>
        <ant:copy todir="${drools.dcontrol.htdocs.module}/checkstyle">
            <ant:fileset file="${basedir}/target/docs/checkstyle-report.html"/>
        </ant:copy>
        <ant:copy todir="${drools.dcontrol.htdocs.module}/checkstyle/xref">
            <ant:fileset dir="${basedir}/target/docs/xref"/>
        </ant:copy>
        <ant:copy todir="${drools.dcontrol.htdocs.module}/checkstyle/style">
            <ant:fileset dir="${basedir}/target/docs/style"/>
        </ant:copy>
        <ant:copy todir="${drools.dcontrol.htdocs.module}/checkstyle/images">
            <ant:fileset dir="${basedir}/target/docs/images"/>
        </ant:copy>
    </goal>

</project>
