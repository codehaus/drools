\section{Semantics Provider Interface}

\subsection{Overview}

\drools{} at its core is merely an algorithmic engine. The 
\emph{Semantics Provide Interface} also known as the SPI
provides for wrapping the \drools{} Rete-OO algorithm with
the desired semantics. The semantics of several concepts are
left open for definition by an implementation.

\bigskip

\begin{center}
  \begin{tabular}{|l|l|p{120pt}|}
    \hline
      \textsf{concept} & \textsf{interface} & \textsf{description} \\
    \hline
    \hline
      \footnotesize{object type} %
        & \texttt{\footnotesize{org.drools.spi.ObjectType}} %
        & \footnotesize{Differentiates objects by type} \\
    \hline
      \footnotesize{condition} %
        & \texttt{\footnotesize{org.drools.spi.FilterCondition}} %
        & \footnotesize{Tests tuples}\\
    \hline
      \footnotesize{fact extraction} %
        & \texttt{\footnotesize{org.drools.spi.FactExtractor}} %
        & \footnotesize{Extracts attributes from objects} \\
    \hline
      \footnotesize{action} %
        & \texttt{\footnotesize{org.drools.spi.Action}} %
        & \footnotesize{Performs activities}\\
    \hline
  \end{tabular}
\end{center}

\bigskip

Additionally, implementations of some of these interfaces must work
with the \verb|Tuple| and \verb|Declaration| objects that flow 
through the network.  

The SPI provides for \drools{} customizations to be linked interal to
the core Rete-OO algorithm engine.  By using SPI implementations, no
external translation or mapping process is required.  Rules can
expressed directly using the semantics provided by the semantics module.

In addition to providing interfaces and classes for specifying
semantic objects, classes for assembling complete rules also exist.
The assembly classes allow whatever UI is required for building rule
sets in a particular application.  

\subsection{Semantic Objects}

\subsubsection{org.drools.spi.ObjectType}

While the type of any object presented to \drools{} though
the fact manipulation methods of a \verb|WorkingMemory| is determined
by the Java class of that object, \drools{} provides the
\verb|ObjectType| interface for determining the object's type within
the engine.

In the \emph{XML Semantics Module}, all presented objects are of the
class \verb|Document|.  The \verb|ObjectType| implementation
for the module inspects the root-level XML element to determine the
object's type for the context of \drools{}.

Semantic modules provide implementation of the \verb|ObjectType|
interface that are capable of determining an object's type within
its semantic realm.

\begin{figure}
\begin{codelisting}
public interface ObjectType
\{
    /** Determine if the passed Object belongs to 
     *  the object type defined by this ObjectType.
     *
     *  @param object The Object to test.
     *
     *  @return true if the Object matches this 
     *          object type, Otherwise false.
     */
    boolean matches(Object object);
\}
\end{codelisting}
\caption{\texttt{org.drools.spi.ObjectType} interface}
\label{code.ObjectType}
\end{figure}

The \verb|matches(...)| method can perform whatever logic that is
neccessary to determine if semantic type of the object matches.  If
the type does match, then \verb|true| should be returned.  Otherwise, 
\verb|false| will indicate a non-match. A single asserted object may 
match several \verb|ObjectTypes| as the core engine presents each 
object to every \verb|ObjectType| for type determination.  This
allows for a rule-base to contain a multitude of rules with different
semantics.  

\subsubsection{org.drools.spi.Declaration}

A \verb|Declaration| represents a named and type object.  Internally,
the \drools{} engine uses strongly-typed semantic objects.  Named objects
involved in a rule have a \verb|Declaration| that binds an object
identifier to an \verb|ObjectType|.  If an object is bound to a
\verb|Declaration|, then the \verb|ObjectType| of the \verb|Declaration|
must return \verb|true| from its \verb|matches(..)| method when
evaluated against the bound object.

\begin{figure}
\begin{codelisting}
public class Declaration
\{
    ....
    ....

    /** Retrieve the ObjectType of this Declaration.
     *
     *  @return The ObjectType of this Declaration.
     */
    public ObjectType getObjectType()
    \{
        return this.objectType;
    \}

    /** Retrieve the variable's identifier.
     *
     *  @return The variable's identifier.
     */
    public String getIdentifier()
    \{
        return this.identifier;
    \}
\}
\end{codelisting}
\label{code.Declaration}
\caption{\texttt{org.drools.spi.Declaration} class}
\end{figure}

\subsubsection{org.drools.spi.Tuple}

While the external \drools{} API is object-oriented, the core is still
constructed of nodes through which \emph{tuples} flow.  A tuple is
simply a dictionary of \emph{key-to-value} entries.  Many times, a
tuple may be considered to be similar to a \emph{row} in a relational
database, where the \emph{key} matches the column type and name, and
the \emph{value} matches the column data cell for that row.  

The \emph{key} used to index the associated value is always a
\verb|Declaration| object. When an object is initially asserted into a
\verb|WorkingMemory|, it gets wrapped by all \verb|ParameterNodes|
into a single-column tuple with the object bound to the
\verb|Declaration| of the \verb|ParameterNode|.

An example set of tuples was presented in table
\fullref{table.tuplesets}. With the exception of the \verb|ObjectType|
interface, semantic modules operate on \verb|Tuple| objects. 

\begin{figure}
\begin{codelisting}
public interface Tuple
{
    /** Retrieve the value bound to a particular Declaration.
     *
     *  @param declaration The Declaration key.
     *
     *  @return The currently bound Object value.
     */
    Object get(Declaration declaration);

    /** Retrieve the Se of all Declarations active in this tuple.
     *
     *  @return The Set of all Declarations in this tuple.
     */
    Set getDeclarations();
}
\end{codelisting}
\label{code.Tuple}
\caption{\texttt{org.drools.spi.Tuple} interface}
\end{figure}

\subsubsection{org.drools.spi.FactExtractor}

Fact extration is the process of performing an operation upon a
\verb|Tuple| to create additional columns or attribute on the
\verb|Tuple|.  All \verb|Tuples| initially have a single column
matching the a \verb|Declaration| of the rule.  Through fact
extraction, additional columns can be added based upon knowledge
gained from the existing column or columns.

The \emph{Java Semantic Module} uses normal Java expressions to
extract other objects and values reachable from those already in the
\verb|Tuple|.  The \emph{XML Semantic Module} uses XPath expressions
to evaluate expressions against documents.  The extracted values are
associated with a \verb|Declaration| and inserted into the
\verb|Tuple|.

Semantics modules provide implementations of the \verb|FactExtractor|
interface to perform fact extraction. A \verb|FactExtractor| may
require more than a single column to perform extraction.  To specify
which columns are required, the \verb|getRequiredTupleMembers()| 
method should return an array of \verb|Declarations| which must 
be present in any tuple presented for extraction.

\begin{figure}
\begin{codelisting}
public interface FactExtractor
\{
    /** Retrieve the array of Declarations required by this 
     *  FactExtractor to perform extraction.
     *
     *  @return The array of Declarations expected 
     *          on incoming Tuples.
     */
    Declaration[] getRequiredTupleMembers();

    /** Extract a new fact from the incoming Tuple.
     *
     *  @param tuple The source data tuple.
     *
     *  @return The newly extract fact object.
     *
     *  @throws FactExtractionException if an error occurs during
     *          fact extraction activities.
     */
    Object extractFact(Tuple tuple) throws FactExtractionException;
\}
\end{codelisting}
\label{code.FactExtractor}
\caption{\texttt{org.drools.spi.FactExtractor} interface}
\end{figure}

\subsubsection{org.drools.spi.FilterCondition}

A \verb|FilterCondition| is a predicate which evaluates against
a \verb|Tuple| to determine if the \verb|Tuple| should pass or
fail the condition. The \verb|isAllowed(Tuple tuple)| method
allows the condition to be evaluated against a \verb|Tuple|.
If the \verb|Tuple| passes the filter, then the method should
return \verb|true| otherwise \verb|false| indicates that
the \verb|Tuple| does not pass.

Like the \verb|FactExtractor|, a
\verb|FilterCondition| may only be applicable to \verb|Tuple|
objects that contain some minimal set of columns.  
\verb|FilterCondition| implementations must also supply
the \verb|getRequiredTupleMembers()| method.

\begin{figure}
\begin{codelisting}
public interface FilterCondition extends Condition
\{
    /** Retrieve the array of Declarations required
     *  by this condition to perform its duties.
     *
     *  @return The array of Declarations expected
     *          on incoming Tuples.
     */
    Declaration[] getRequiredTupleMembers();

    /** Determine if the supplied Tuple is allowed
     *  by this filter.
     *
     *  @param tuple The <code>Tuple</code> to test.
     *
     *  @return <code>true</code> if the <code>Tuple</code>
     *          passes this filter, else <code>false</code>.
     *
     *  @throws FilterException if an error occurs during filtering.
     */
    boolean isAllowed(Tuple tuple) throws FilterException;
\}
\end{codelisting}
\label{code.FilterCondition}
\caption{\texttt{org.drools.spi.FilterCondition} interface}
\end{figure}

\subsubsection{org.drools.spi.Action}

When a collection of facts, represented by a \verb|Tuple| satisifies
all conditions of a rule then an \verb|Action| is given an opportunity
to fire and perform some activity.  Since \verb|Actions| may require
the ability to manipulate more facts, instaces are provided not only
the matching \verb|Tuple|, but also the current \verb|WorkingMemory|
instance.

\begin{figure}
\begin{codelisting}
public interface Action
\{
    /** Execute the action for the supplied matching Tuple.
     *
     *  @param tuple The matching tuple.
     *  @param workingMemory The working memory session.
     *
     *  @throws ActionInvokationException If an error occurs while
     *          attempting to invoke the action.
     */
    void invoke(Tuple tuple,
                WorkingMemory workingMemory) throws ActionInvokationException;
\}
\end{codelisting}
\label{code.Action}
\caption{\texttt{org.drools.spi.Action} interface}
\end{figure}

\newpage
